name: Build Tauri (Windows Portable)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_NET_RETRY: 3

jobs:
  build-windows-portable:
    name: Windows (Portable EXE)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if fast build
        id: check_fast
        shell: bash
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"dbuild"* ]]; then
            echo "is_fast=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Fast build mode enabled (optimized for speed)"
          else
            echo "is_fast=false" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Standard build mode (optimized for size)"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install JS dependencies
        run: npm ci

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies (Fast mode)
        if: steps.check_fast.outputs.is_fast == 'true'
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust-fast"
          shared-key: "fast-build"
          cache-on-failure: true
          save-if: true

      - name: Cache Rust dependencies (Standard mode)
        if: steps.check_fast.outputs.is_fast == 'false'
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust-standard"
          shared-key: "standard-build"
          cache-on-failure: false

      - name: Set fast build environment
        if: steps.check_fast.outputs.is_fast == 'true'
        shell: bash
        run: |
          # Enable incremental compilation for faster rebuilds
          echo "CARGO_INCREMENTAL=1" >> $GITHUB_ENV
          # Use more codegen units for parallel compilation (faster build)
          echo "CARGO_PROFILE_RELEASE_CODEGEN_UNITS=16" >> $GITHUB_ENV
          # Use thin LTO instead of fat LTO (faster linking)
          echo "CARGO_PROFILE_RELEASE_LTO=thin" >> $GITHUB_ENV
          # Reduce optimization level slightly for faster compilation
          echo "CARGO_PROFILE_RELEASE_OPT_LEVEL=2" >> $GITHUB_ENV
          # Still strip symbols
          echo "CARGO_PROFILE_RELEASE_STRIP=symbols" >> $GITHUB_ENV
          # Keep panic=abort
          echo "CARGO_PROFILE_RELEASE_PANIC=abort" >> $GITHUB_ENV
          echo "BUILD_MODE=fast" >> $GITHUB_ENV

      - name: Set standard build environment
        if: steps.check_fast.outputs.is_fast == 'false'
        shell: bash
        run: |
          # Disable incremental for smaller artifacts and reproducibility
          echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV
          # Single codegen unit for maximum optimization
          echo "CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1" >> $GITHUB_ENV
          # Fat LTO for maximum runtime performance
          echo "CARGO_PROFILE_RELEASE_LTO=fat" >> $GITHUB_ENV
          # Maximum optimization for best runtime performance
          echo "CARGO_PROFILE_RELEASE_OPT_LEVEL=3" >> $GITHUB_ENV
          # Strip symbols
          echo "CARGO_PROFILE_RELEASE_STRIP=symbols" >> $GITHUB_ENV
          # Panic abort for smaller binary
          echo "CARGO_PROFILE_RELEASE_PANIC=abort" >> $GITHUB_ENV
          # Additional optimizations for maximum performance
          echo "RUSTFLAGS=-C target-cpu=x86-64-v2" >> $GITHUB_ENV
          echo "BUILD_MODE=standard" >> $GITHUB_ENV

      - name: Build Tauri (Fast)
        if: steps.check_fast.outputs.is_fast == 'true'
        run: |
          echo "ðŸš€ Building in FAST mode (incremental + thin LTO + parallel codegen)..."
          npm run tauri:build

      - name: Build Tauri (Standard)
        if: steps.check_fast.outputs.is_fast == 'false'
        run: |
          echo "ðŸ“¦ Building in STANDARD mode (fat LTO + single codegen unit)..."
          npm run tauri:build

      - name: Rename EXE
        run: Rename-Item -Path "target/release/xfastinstall.exe" -NewName "XFastInstall.exe" -Force

      - name: Upload Fast Build
        if: steps.check_fast.outputs.is_fast == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: XFastInstall-windows-fast
          path: 'target/release/XFastInstall.exe'
          if-no-files-found: error
          retention-days: 7

      - name: Upload Standard Build
        if: steps.check_fast.outputs.is_fast == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: XFastInstall-windows-portable
          path: 'target/release/XFastInstall.exe'
          if-no-files-found: error


