name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always
  CARGO_NET_RETRY: 3

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag: ${{ steps.get-version.outputs.tag }}
      changelog: ${{ steps.extract-changelog.outputs.changelog }}
      is_prerelease: ${{ steps.check-prerelease.outputs.is_prerelease }}
      should_release: ${{ steps.check-tag.outputs.skip != 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Get version from tauri.conf.json
        id: get-version
        run: |
          VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"
          echo "ğŸ·ï¸  Tag: v$VERSION"

      - name: Check if pre-release
        id: check-prerelease
        run: |
          VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          if [ "$MAJOR" = "0" ]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Pre-release detected (version < 1.0.0)"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "âœ… Stable release (version >= 1.0.0)"
          fi

      - name: Check if tag exists
        id: check-tag
        run: |
          VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "âš ï¸ Tag v$VERSION already exists, skipping release."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Tag v$VERSION does not exist, proceeding..."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog for this version
        if: steps.check-tag.outputs.skip != 'true'
        id: extract-changelog
        run: |
          VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")

          # Extract the changelog section for this version
          CHANGELOG=$(awk -v ver="## [$VERSION]" '
            index($0, ver) == 1 { found=1; print; next }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md | sed -e :a -e '/^\n*$/{$d;N;ba' -e '}' | head -c 65000)

          if [ -z "$CHANGELOG" ] || [ "$(echo "$CHANGELOG" | tr -d '[:space:]')" = "" ]; then
            echo "âš ï¸  No changelog found for version $VERSION"
            echo "Please add a changelog entry for version $VERSION in CHANGELOG.md"
            echo ""
            echo "Expected format:"
            echo "## [$VERSION] - YYYY-MM-DD"
            echo ""
            echo "### Added"
            echo "- Feature descriptions here"
            exit 1
          else
            echo "âœ… Extracted changelog for version $VERSION"
          fi

          # Write to file to avoid issues with multiline in GitHub Actions
          echo "$CHANGELOG" > /tmp/changelog.txt
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit version sync
        if: steps.check-tag.outputs.skip != 'true'
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add package.json
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            git commit -m "chore: sync version to package.json"
            git push
            echo "âœ… Committed and pushed version sync"
          fi

  build:
    name: Build (${{ matrix.suffix }})
    needs: prepare-release
    if: needs.prepare-release.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            args: ''
            suffix: linux-x64
            artifact_glob: 'target/release/bundle/appimage/*.AppImage'
            artifact_suffix: linux-x64.AppImage
          - platform: macos-latest
            args: '--target universal-apple-darwin'
            suffix: macos-universal
            artifact_glob: 'target/universal-apple-darwin/release/bundle/dmg/*.dmg'
            artifact_suffix: macos-universal.dmg
          - platform: windows-latest
            args: ''
            suffix: windows-x64
            artifact_glob: 'target/release/xfastmanager.exe'
            artifact_suffix: windows-portable.exe

    runs-on: ${{ matrix.platform }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: main

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf rpm

      - name: Add macOS targets
        if: matrix.platform == 'macos-latest'
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install JS dependencies
        run: npm ci

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v2-rust-release"
          key: "release-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}"
          cache-all-crates: true

      - name: Set production build environment
        shell: bash
        run: |
          echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV
          echo "CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1" >> $GITHUB_ENV
          echo "CARGO_PROFILE_RELEASE_LTO=fat" >> $GITHUB_ENV
          echo "CARGO_PROFILE_RELEASE_OPT_LEVEL=3" >> $GITHUB_ENV
          echo "CARGO_PROFILE_RELEASE_STRIP=symbols" >> $GITHUB_ENV
          echo "CARGO_PROFILE_RELEASE_PANIC=abort" >> $GITHUB_ENV
          echo "BUILD_MODE=production" >> $GITHUB_ENV
          echo "âœ… Production build environment configured"

      - name: Build Tauri
        shell: bash
        run: |
          echo "ğŸ”¨ Building XFast-Manager ${{ needs.prepare-release.outputs.version }} for ${{ matrix.suffix }}..."
          if [ -n "${{ matrix.args }}" ]; then
            npm run tauri:build -- ${{ matrix.args }}
          else
            npm run tauri:build
          fi

      - name: Prepare Windows artifact
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $version = "${{ needs.prepare-release.outputs.version }}"

          # Portable exe
          $portableName = "XFast-Manager-$version-windows-portable.exe"
          Rename-Item -Path "target/release/xfastmanager.exe" -NewName $portableName -Force
          echo "âœ… Portable exe prepared: $portableName"

          # MSI installer
          $msiFile = Get-ChildItem -Path "target/release/bundle/msi/*.msi" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($msiFile) {
            $msiName = "XFast-Manager-$version-windows-setup.msi"
            Rename-Item -Path $msiFile.FullName -NewName $msiName -Force
            echo "âœ… MSI installer prepared: $msiName"
          } else {
            echo "âš ï¸ No MSI installer found"
          }

      - name: Prepare macOS artifact
        if: matrix.platform == 'macos-latest'
        shell: bash
        run: |
          version="${{ needs.prepare-release.outputs.version }}"
          dmg_file=$(ls target/universal-apple-darwin/release/bundle/dmg/*.dmg)
          new_name="XFast-Manager-${version}-macos-universal.dmg"
          mv "$dmg_file" "target/universal-apple-darwin/release/bundle/dmg/$new_name"

      - name: Prepare Linux artifact
        if: matrix.platform == 'ubuntu-22.04'
        shell: bash
        run: |
          version="${{ needs.prepare-release.outputs.version }}"

          # AppImage
          appimage_file=$(ls target/release/bundle/appimage/*.AppImage 2>/dev/null || true)
          if [ -n "$appimage_file" ]; then
            mv "$appimage_file" "target/release/bundle/appimage/XFast-Manager-${version}-linux-x64.AppImage"
            echo "âœ… AppImage prepared"
          fi

          # deb package
          deb_file=$(ls target/release/bundle/deb/*.deb 2>/dev/null || true)
          if [ -n "$deb_file" ]; then
            mv "$deb_file" "target/release/bundle/deb/XFast-Manager-${version}-linux-x64.deb"
            echo "âœ… deb package prepared"
          fi

          # rpm package
          rpm_file=$(ls target/release/bundle/rpm/*.rpm 2>/dev/null || true)
          if [ -n "$rpm_file" ]; then
            mv "$rpm_file" "target/release/bundle/rpm/XFast-Manager-${version}-linux-x64.rpm"
            echo "âœ… rpm package prepared"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.suffix }}
          path: |
            target/release/XFast-Manager-*-windows-portable.exe
            target/release/bundle/msi/XFast-Manager-*-windows-setup.msi
            target/universal-apple-darwin/release/bundle/dmg/XFast-Manager-*-macos-universal.dmg
            target/release/bundle/appimage/XFast-Manager-*-linux-x64.AppImage
            target/release/bundle/deb/XFast-Manager-*-linux-x64.deb
            target/release/bundle/rpm/XFast-Manager-*-linux-x64.rpm
          if-no-files-found: ignore
          retention-days: 7

  release:
    name: Create Release
    needs: [prepare-release, build]
    if: needs.prepare-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-*
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "ğŸ“¦ Downloaded artifacts:"
          find artifacts -type f -name "XFast-Manager-*" | head -20

      - name: Prepare release files
        shell: bash
        run: |
          mkdir -p release-files
          version="${{ needs.prepare-release.outputs.version }}"

          # Find and copy all artifacts to release-files
          find artifacts -type f -name "XFast-Manager-*" -exec cp {} release-files/ \;

          cd release-files

          # Zip Windows portable exe
          if [ -f "XFast-Manager-${version}-windows-portable.exe" ]; then
            zip "XFast-Manager-${version}-windows-portable.zip" "XFast-Manager-${version}-windows-portable.exe"
            rm "XFast-Manager-${version}-windows-portable.exe"
          fi

          # Zip Windows MSI installer
          if [ -f "XFast-Manager-${version}-windows-setup.msi" ]; then
            zip "XFast-Manager-${version}-windows-setup.zip" "XFast-Manager-${version}-windows-setup.msi"
            rm "XFast-Manager-${version}-windows-setup.msi"
          fi

          # Zip macOS DMG
          if [ -f "XFast-Manager-${version}-macos-universal.dmg" ]; then
            zip "XFast-Manager-${version}-macos-universal.zip" "XFast-Manager-${version}-macos-universal.dmg"
            rm "XFast-Manager-${version}-macos-universal.dmg"
          fi

          # Zip Linux AppImage
          if [ -f "XFast-Manager-${version}-linux-x64.AppImage" ]; then
            zip "XFast-Manager-${version}-linux-x64-AppImage.zip" "XFast-Manager-${version}-linux-x64.AppImage"
            rm "XFast-Manager-${version}-linux-x64.AppImage"
          fi

          # Zip Linux deb
          if [ -f "XFast-Manager-${version}-linux-x64.deb" ]; then
            zip "XFast-Manager-${version}-linux-x64-deb.zip" "XFast-Manager-${version}-linux-x64.deb"
            rm "XFast-Manager-${version}-linux-x64.deb"
          fi

          # Zip Linux rpm
          if [ -f "XFast-Manager-${version}-linux-x64.rpm" ]; then
            zip "XFast-Manager-${version}-linux-x64-rpm.zip" "XFast-Manager-${version}-linux-x64.rpm"
            rm "XFast-Manager-${version}-linux-x64.rpm"
          fi

          # Generate checksums (only for zip files)
          sha256sum XFast-Manager-*.zip > checksums.txt

          echo "âœ… Release files prepared:"
          ls -la
          echo ""
          echo "ğŸ“‹ Checksums:"
          cat checksums.txt

      - name: Create Git Tag
        shell: bash
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git tag -a "${{ needs.prepare-release.outputs.tag }}" -m "Release ${{ needs.prepare-release.outputs.tag }}"
          git push origin "${{ needs.prepare-release.outputs.tag }}"
          echo "âœ… Created and pushed tag: ${{ needs.prepare-release.outputs.tag }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          name: XFast-Manager ${{ needs.prepare-release.outputs.tag }}
          body: ${{ needs.prepare-release.outputs.changelog }}
          draft: false
          prerelease: ${{ needs.prepare-release.outputs.is_prerelease == 'true' }}
          files: |
            release-files/XFast-Manager-${{ needs.prepare-release.outputs.version }}-windows-portable.zip
            release-files/XFast-Manager-${{ needs.prepare-release.outputs.version }}-windows-setup.zip
            release-files/XFast-Manager-${{ needs.prepare-release.outputs.version }}-macos-universal.zip
            release-files/XFast-Manager-${{ needs.prepare-release.outputs.version }}-linux-x64-AppImage.zip
            release-files/XFast-Manager-${{ needs.prepare-release.outputs.version }}-linux-x64-deb.zip
            release-files/XFast-Manager-${{ needs.prepare-release.outputs.version }}-linux-x64-rpm.zip
            release-files/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        shell: bash
        run: |
          echo "ğŸ‰ Release ${{ needs.prepare-release.outputs.tag }} created successfully!"
          echo "ğŸ“¦ Version: ${{ needs.prepare-release.outputs.version }}"
          echo "ğŸ·ï¸  Tag: ${{ needs.prepare-release.outputs.tag }}"
          if [ "${{ needs.prepare-release.outputs.is_prerelease }}" = "true" ]; then
            echo "âš ï¸  Type: Pre-release (version < 1.0.0)"
          else
            echo "âœ… Type: Stable release"
          fi
          echo ""
          echo "ğŸ“¦ Artifacts included:"
          echo "  - Windows (portable): XFast-Manager-${{ needs.prepare-release.outputs.version }}-windows-portable.zip"
          echo "  - Windows (installer): XFast-Manager-${{ needs.prepare-release.outputs.version }}-windows-setup.zip"
          echo "  - macOS:   XFast-Manager-${{ needs.prepare-release.outputs.version }}-macos-universal.zip"
          echo "  - Linux (AppImage): XFast-Manager-${{ needs.prepare-release.outputs.version }}-linux-x64-AppImage.zip"
          echo "  - Linux (deb): XFast-Manager-${{ needs.prepare-release.outputs.version }}-linux-x64-deb.zip"
          echo "  - Linux (rpm): XFast-Manager-${{ needs.prepare-release.outputs.version }}-linux-x64-rpm.zip"
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare-release.outputs.tag }}"
