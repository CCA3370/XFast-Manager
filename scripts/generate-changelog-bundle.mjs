import fs from 'node:fs/promises'
import path from 'node:path'
import { fileURLToPath } from 'node:url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)
const root = path.resolve(__dirname, '..')

const sourcePath = path.join(root, 'CHANGELOG.md')
const targetDir = path.join(root, 'src', 'generated')
const targetPath = path.join(targetDir, 'changelog.ts')

async function main() {
  const content = await fs.readFile(sourcePath, 'utf8')
  await fs.mkdir(targetDir, { recursive: true })
  const output =
    `// Auto-generated by scripts/generate-changelog-bundle.mjs\n` +
    `// Do not edit manually.\n` +
    `const bundledChangelog = ${JSON.stringify(content)}\n` +
    `export default bundledChangelog\n`

  await fs.writeFile(targetPath, output, 'utf8')
  process.stdout.write(`[changelog] bundled -> ${path.relative(root, targetPath)}\n`)
}

main().catch((error) => {
  process.stderr.write(`[changelog] generate failed: ${String(error)}\n`)
  process.exit(1)
})

